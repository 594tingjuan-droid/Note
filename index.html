<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
  <meta http-equiv=â€Refreshâ€ content=â€0;url=http://Noteâ€>
  <title>æ¸¬è©¦ç­†è¨˜</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 60px;
      background: #E3D4FA;
      font-size: 28px;
      font-weight: bold;
      color: #333;
      line-height: 60px;
      padding-left: 20px;
      z-index: 10;
      border-bottom: 1px solid #ccc;
    }
    .sidebar {
      margin-top: 60px;
      width: 220px;
      background-color: #E6E6FA;
      padding: 10px;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
    }
    .sidebar li {
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
      border-bottom: 1px solid #aaa;
      position: relative;
      user-select: none;
    }
    .sidebar li:hover {
      background-color: #D5DAEB;
    }
    .sidebar li.active {
      background-color: #F5F7FA;
    }
    .sidebar li button.delete-cat-btn {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 16px;
      color: #900;
      user-select: none;
    }
    .sidebar .add-category {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }
    .sidebar .add-category input {
      width: 100%;
      padding: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .sidebar .add-category button {
      width: 100%;
      margin-top: 5px;
      padding: 6px 8px;
      font-size: 14px;
      cursor: pointer;
      background-color: #5cb85c;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: bold;
    }
    .main {
      flex: 1;
      margin-top: 60px;
      padding: 20px;
      overflow-y: auto;
    }
    .search-add {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-add input {
      flex: 1;
      padding: 10px;
      font-size: px;
    }
    .search-add button {
      padding: 10px 15px;
      font-weight: bold;
      cursor: pointer;
      background: #5cb85c;
      color: white;
      border: none;
      border-radius: 4px;
    }
    .title-input {
      font-size: 20px;
      padding: 8px;
      width: 100%;
      border: none;
      border-bottom: 2px solid #ccc;
      margin-bottom: 10px;
      display: none;
    }
    .toolbar {
      display: none;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .toolbar select,
    .toolbar button {
      padding: 6px 8px;
      font-size: 14px;
      cursor: pointer;
    }
    #editor {
      display: none;
      border: 1px solid #ccc;
      padding: 15px;
      min-height: 550px;
      background: #fff;
      overflow-y: auto;
    }
	
    .color-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .note-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .note-item {
      background: #fffaf5;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .note-item:hover {
      background: #fff0e5;
    }
    .note-title {
      font-weight: bold;
    }
    .note-time {
      font-size: 12px;
      color: #666;
    }
    .note-category {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }
	 .toolbar {
    display: none;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
    position: relative; /* âœ… æ–°å¢ï¼šè®“èª¿è‰²ç›¤å®šä½ç›¸å°æ–¼é€™è£¡ */
  }
  
#color-palette {
  display: grid;
  grid-template-columns: repeat(8, 30px); /* 9æ¬„ï¼Œæ¯å€‹è‰²å¡Š30pxå¯¬ */
  grid-template-rows: repeat(7, 30px);    /* 7åˆ—ï¼Œæ¯å€‹è‰²å¡Š30pxé«˜ (å› ç‚ºæœ‰7è‰²ç³») */
  gap: 2px; /* è‰²å¡Šé–“è·ç¸®å° */
  padding: 4px;
  border-radius: 12px;
  border: 2px solid;
  position: absolute;
  z-index: 1000;
  box-shadow: 0 6px 15px rgba(188, 163, 202, 0.4);
  user-select: none;
  width: max-content;
  transition: opacity 0.3s ease, transform 0.3s ease;
  transform-origin: top left;
  background-color: white;
}


#color-palette.show {
  display: grid;
  opacity: 1;
  transform: scale(1);
}

.color-btn {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: transform 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.12);
}

.color-btn:hover {
  transform: scale(1.3);
  border-color: #6a4bcf;
  box-shadow: 0 0 8px 3px rgba(106, 75, 207, 0.6);
}

.color-row {
  display: contents; /* ä¿æŒgridå¸ƒå±€ */
}

  /* çµ±ä¸€æŒ‰éˆ•å¤–è§€ */
button {
  border: none;
  padding: 8px 12px;
  font-size: 14px;
  font-weight: bold;
  border-radius: 8px; /* åœ“æ½¤è§’è½ */
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  background-color: #f0f0f0;
  color: #333;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* æ»‘é¼ æ‡¸åœæ™‚ */
button:hover {
  background-color: #e4e4e4;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

/* ç‰¹æ®ŠæŒ‰éˆ•è‡ªå®šç¾©ï¼šæ–°å¢åˆ†é¡ */
.sidebar .add-category button {
  background-color: #BCA3CA;
  color: Black;
}

/* ç‰¹æ®ŠæŒ‰éˆ•ï¼šæ–°å¢ç­†è¨˜ */
#new-note-btn {
  background-color: #BCA3CA;
  color: Black;
}

/* å·¥å…·åˆ—æŒ‰éˆ• */
.toolbar button {
  background-color: #f5f5f5;
  color: #333;
}

.toolbar button:hover {
  background-color: #e0e0e0;
}

/* åˆªé™¤åˆ†é¡æŒ‰éˆ• */
.sidebar li button.delete-cat-btn {
  background-color: transparent;
  color: #d9534f;
  font-size: 16px;
  border-radius: 50%;
  padding: 2px 6px;
  transition: background 0.2s ease;
}

.sidebar li button.delete-cat-btn:hover {
  background-color: #ffe5e5;
}

/* é¡è‰²æŒ‰éˆ•åœ“æ½¤åŒ– */
.color-btn {
  border-radius: 50%;
  border: 1px solid #aaa;
  width: 24px;
  height: 24px;
  transition: transform 0.2s;
}

.color-btn:hover {
  transform: scale(1.2);
  border-color: #444;
}

.toolbar select:hover,
.toolbar button:hover {
  background-color: #F5F5F5;
}

.toolbar select,
.toolbar button {
  padding: 6px 8px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 8px; /* åœ“æ½¤è§’è½ */
  border: 1px solid #ccc;
  background-color: #f9f9f9;
  transition: all 0.2s ease-in-out;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.toolbar select:hover,
.toolbar button:hover {
  background-color: #F5F5F5;
}

/* è®“æœå°‹æ¬„ã€åˆ†é¡è¼¸å…¥æ¬„ã€æ¨™é¡Œæ¬„ä¹Ÿåœ“æ½¤ */
#search-input,
#new-category-input,
#note-title {
  border-radius: 8px;
  border: 1px solid #ccc;
  padding: 10px;
  font-size: 16px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease-in-out;
}

/* æ»‘é¼ èšç„¦æ™‚çš„æ•ˆæœ */
#search-input:focus,
#new-category-input:focus,
#note-title:focus {
  outline: none;
  border-color: #BCA3CA;
  box-shadow: 0 0 5px rgba(188, 163, 202, 0.5);
}
#save-btn {
  margin-left: auto;
}
/* è¢«æ‹–å‹•æ™‚çš„æ¨£å¼ */
li.dragging {
  opacity: 0.5;
}

/* æ‹–å‹•ç¶“éå…¶ä»– li æ™‚çš„æç¤ºæ¨£å¼ */
li.drag-over {
  border-top: 2px dashed #888;
}
.custom-font-size {
  display: inline;
}

  </style>
</head>
<body>
  <div class="header">é›·æ°ç­†è¨˜</div>

  <div class="sidebar">
    <ul id="sidebar-list">
      <!-- åˆ†é¡åˆ—è¡¨å‹•æ…‹ç”Ÿæˆ -->
    </ul>
    <div class="add-category">
    <input type="text" id="new-category-input" placeholder="åˆ†é¡é€™é‚Š(Â´â–½`Êƒâ™¡Æª)" />
     <button id="add-category-btn">æ–°å¢åˆ†é¡</button>
    </div>
  </div>

  <div class="main">
    <div class="search-add" id="search-add-area">
      <input type="text" id="search-input" placeholder="é€™é‚Šå¯ä»¥å¹«ä½ æ‰¾åˆ°å¾ˆå¤šç­†è¨˜å‘¦ âœ¿à¥°à¥±*ï½¡ï¾Ÿâœ¿à¥°à¥±*ï½¡ï¾Ÿâœ¿à¥°à¥±*ï½¡ï¾Ÿâœ¿à¥°à¥±*ï½¡ï¾Ÿ" />
      <button id="new-note-btn">æ–°å¢ç­†è¨˜</button>
    </div>

    <input type="text" id="note-title" class="title-input" placeholder="å‘Šè¨´æˆ‘è¼¸å…¥ä»€éº¼æ¨™é¡Œæ‰è¨˜å¾—ä½ï¼Œå°±è¼¸å…¥é‚£å€‹å§â€¦" />
    <div class="toolbar" id="toolbar">
  <select id="font-select" title="å­—å‹é¸æ“‡">
    <option value="'Comic Sans MS', monospace">Comic Sans MS</option>

  </select>

  <select id="font-size-select" title="æ–‡å­—å¤§å°">
    <option value="14px">14px</option>
    <option value="16px" selected>16px</option>
    <option value="20px">20px</option>
    <option value="24px">24px</option>
    <option value="30px">30px</option>
  </select>

  <button id="color-picker-btn" title="æ–‡å­—é¡è‰²">ğŸ¨</button>
  <button id="bold-btn" title="ç²—é«”">B</button>
  <button id="italic-btn" title="æ–œé«”">I</button>
  <button id="underline-btn" title="åº•ç·š">U</button>
  <button id="bullet-list-btn" title="é …ç›®ç¬¦è™Ÿæ¸…å–®">â€¢ åˆ—è¡¨</button>
<button id="insert-img-btn">æ’å…¥åœ–ç‰‡</button>
<input type="file" id="img-input" accept="image/*" style="display: none;">
  

  <button id="save-btn" title="å„²å­˜ç­†è¨˜">å„²å­˜</button>
  <button id="delete-btn" title="åˆªé™¤ç­†è¨˜">åˆªé™¤</button>
</div>


    <div id="color-palette"></div>

    <div id="editor" contenteditable="true"></div>

    <div class="note-list" id="note-list"></div>
  </div>

  
  
<style>
#color-palette {
  display: none; /* é è¨­éš±è— */
  gap: 1px; /* æŒ‰éˆ•é–“è· */
  padding: 6px;
  border-radius: 12px;
  border: 2px solid;
  position: absolute;
  z-index: 1000;
  box-shadow: 0 6px 15px rgba(188, 163, 202, 0.4);
  width: max-content;
  user-select: none;
  transition: opacity 0.3s ease, transform 0.3s ease;
  transform-origin: top left;
}

  #color-palette.show {
    display: grid;
  }

.color-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 1px solid #aaa;
  transition: transform 0.2s;
  margin: 0;
}
/* åœ–ç‰‡ wrapper å’ŒæŠŠæ‰‹æ¨£å¼ */
.img-resizer-wrapper {
  display: inline-block;
  position: relative;
}

.img-resizer-wrapper img {
  display: block;
  max-width: 100%;
  height: auto;
}

.resizer-handle {
  width: 8px;
  height: 8px;
  background: white;
  border: 1px solid #666;
  position: absolute;
  z-index: 10;
}

.resizer-handle.nw { left: -4px; top: -4px; cursor: nw-resize; }
.resizer-handle.ne { right: -4px; top: -4px; cursor: ne-resize; }
.resizer-handle.sw { left: -4px; bottom: -4px; cursor: sw-resize; }
.resizer-handle.se { right: -4px; bottom: -4px; cursor: se-resize; }
</style>

<script>
  // å…ƒç´ å–å¾—
  const newNoteBtn = document.getElementById('new-note-btn');
  const noteTitle = document.getElementById('note-title');
  const toolbar = document.getElementById('toolbar');
  const editor = document.getElementById('editor');
  const saveBtn = document.getElementById('save-btn');
  const deleteBtn = document.getElementById('delete-btn');
  const fontSelect = document.getElementById('font-select');
  const fontSizeSelect = document.getElementById('font-size-select');
  const colorPickerBtn = document.getElementById('color-picker-btn');
  const colorPalette = document.getElementById('color-palette');
  const boldBtn = document.getElementById('bold-btn');
  const italicBtn = document.getElementById('italic-btn');
  const underlineBtn = document.getElementById('underline-btn');
  const searchInput = document.getElementById('search-input');
  const noteList = document.getElementById('note-list');
  const searchAddArea = document.getElementById('search-add-area');
  const sidebarList = document.getElementById('sidebar-list');
  const newCategoryInput = document.getElementById('new-category-input');
  const addCategoryBtn = document.getElementById('add-category-btn');
  const output = document.getElementById('output');

  // åœ¨ä½ çš„ script è£¡é¢ï¼Œæ‹¿åˆ°å…ƒç´ 
const insertImgBtn = document.getElementById('insert-img-btn');
const imgInput = document.getElementById('img-input');

// è§¸ç™¼é¸æª”æ¡ˆ
insertImgBtn.onclick = () => {
  imgInput.click();
};

imgInput.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    const dataURL = evt.target.result;

    // å»ºç«‹ img
    const img = document.createElement('img');
    img.src = dataURL;
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.style.cursor = 'move';

    // å»ºç«‹ wrapper ä¸¦åŒ…è£ img
    const wrapper = document.createElement('span');
    wrapper.className = 'img-resizer-wrapper';
    wrapper.style.display = 'inline-block';
    wrapper.style.position = 'relative';
    wrapper.style.userSelect = 'none';

    wrapper.appendChild(img);

    // åŠ å››å€‹æ§åˆ¶é»ï¼Œä¸¦ç¶å®šäº‹ä»¶
    ['nw','ne','sw','se'].forEach(corner => {
      const handle = document.createElement('span');
      handle.className = 'resizer-handle ' + corner;
      handle.style.width = '8px';
      handle.style.height = '8px';
      handle.style.background = 'white';
      handle.style.border = '1px solid #666';
      handle.style.position = 'absolute';
      handle.style.cursor = corner + '-resize';
      if (corner === 'nw') { handle.style.left = '-4px'; handle.style.top = '-4px'; }
      if (corner === 'ne') { handle.style.right = '-4px'; handle.style.top = '-4px'; }
      if (corner === 'sw') { handle.style.left = '-4px'; handle.style.bottom = '-4px'; }
      if (corner === 'se') { handle.style.right = '-4px'; handle.style.bottom = '-4px'; }

      wrapper.appendChild(handle);

      let startX, startY, startWidth, startHeight;
      handle.addEventListener('mousedown', (eh) => {
        eh.stopPropagation();
        startX = eh.clientX;
        startY = eh.clientY;
        startWidth = img.offsetWidth;
        startHeight = img.offsetHeight;

        const aspect = startWidth / startHeight;

        function onMouseMove(e2) {
          const dx = e2.clientX - startX;
          const dy = e2.clientY - startY;

          let newWidth = startWidth;
          let newHeight = startHeight;

          if (corner.includes('e')) newWidth = startWidth + dx;
          if (corner.includes('s')) newHeight = startHeight + dy;
          if (corner.includes('w')) newWidth = startWidth - dx;
          if (corner.includes('n')) newHeight = startHeight - dy;

          // ç­‰æ¯”ä¾‹ç¸®æ”¾
          if (Math.abs(dx) > Math.abs(dy)) {
            newHeight = newWidth / aspect;
          } else {
            newWidth = newHeight * aspect;
          }

          if (newWidth > 20) img.style.width = newWidth + 'px';
          if (newHeight > 20) img.style.height = newHeight + 'px';
        }

        function onMouseUp() {
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        }

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    });

    // åœ¨æ¸¸æ¨™ä½ç½®æ’å…¥ wrapperï¼ˆåŒ…å«åœ–ç‰‡å’Œæ§åˆ¶é»ï¼‰
    insertNodeAtCursor(wrapper);

    editor.focus();
  };
  reader.readAsDataURL(file);
  e.target.value = '';
};

// helper å‡½å¼æ’å…¥ç¯€é»åˆ°æ¸¸æ¨™ä½ç½®
function insertNodeAtCursor(node) {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  range.deleteContents();
  range.insertNode(node);

  // ç§»å‹•æ¸¸æ¨™åˆ°æ’å…¥ç¯€é»ä¹‹å¾Œï¼Œé¿å…æ¸¸æ¨™äº‚è·‘
  range.setStartAfter(node);
  sel.removeAllRanges();
  sel.addRange(range);
}

// è²¼ä¸Šåœ–ç‰‡å¾Œï¼Œè‡ªå‹•å¥—ç”¨ç¸®æ”¾åŠŸèƒ½
editor.addEventListener('paste', (e) => {
  // ç­‰ä¸€å€‹å¾®ä»»å‹™ï¼Œè®“è²¼ä¸Šå‹•ä½œå®Œæˆ
  setTimeout(() => {
    // æ‰¾åˆ° editor è£¡æ‰€æœ‰æ²’æœ‰åŒ… wrapper çš„ img
    const imgs = editor.querySelectorAll('img');

    imgs.forEach(img => {
      // å¦‚æœ img å·²ç¶“æœ‰ wrapperï¼Œè·³é
      if (img.parentElement && img.parentElement.classList.contains('img-resizer-wrapper')) return;

      // é€²è¡ŒåŒ…è£ï¼Œä¸¦åŠ å…¥æ§åˆ¶é»
      wrapImageWithResizer(img);
    });
  }, 0);
});

// å°‡åœ–ç‰‡åŒ…è£ä¸¦åŠ ä¸Šæ§åˆ¶é»çš„å‡½å¼ï¼ˆè·Ÿæ’å…¥åœ–ç‰‡éƒ¨åˆ†é‚è¼¯ä¸€æ¨£ï¼‰
function wrapImageWithResizer(img) {
  // å»ºç«‹ wrapper
  const wrapper = document.createElement('span');
  wrapper.className = 'img-resizer-wrapper';
  wrapper.style.display = 'inline-block';
  wrapper.style.position = 'relative';
  wrapper.style.userSelect = 'none';

  // å°‡ img æ”¾é€² wrapper è£¡
  img.parentNode.insertBefore(wrapper, img);
  wrapper.appendChild(img);

  // é‡æ–°è¨­å®šåœ–ç‰‡ styleï¼Œé¿å…å½±éŸ¿é¡¯ç¤º
  img.style.maxWidth = '100%';
  img.style.height = 'auto';
  img.style.cursor = 'move';

  // åŠ å››å€‹æ§åˆ¶é»ä¸¦ç¶äº‹ä»¶
  ['nw','ne','sw','se'].forEach(corner => {
    const handle = document.createElement('span');
    handle.className = 'resizer-handle ' + corner;
    handle.style.width = '8px';
    handle.style.height = '8px';
    handle.style.background = 'white';
    handle.style.border = '1px solid #666';
    handle.style.position = 'absolute';
    handle.style.cursor = corner + '-resize';
    if (corner === 'nw') { handle.style.left = '-4px'; handle.style.top = '-4px'; }
    if (corner === 'ne') { handle.style.right = '-4px'; handle.style.top = '-4px'; }
    if (corner === 'sw') { handle.style.left = '-4px'; handle.style.bottom = '-4px'; }
    if (corner === 'se') { handle.style.right = '-4px'; handle.style.bottom = '-4px'; }

    wrapper.appendChild(handle);

    let startX, startY, startWidth, startHeight;
    handle.addEventListener('mousedown', (eh) => {
      eh.stopPropagation();
      startX = eh.clientX;
      startY = eh.clientY;
      startWidth = img.offsetWidth;
      startHeight = img.offsetHeight;

      const aspect = startWidth / startHeight;

      function onMouseMove(e2) {
        const dx = e2.clientX - startX;
        const dy = e2.clientY - startY;

        let newWidth = startWidth;
        let newHeight = startHeight;

        if (corner.includes('e')) newWidth = startWidth + dx;
        if (corner.includes('s')) newHeight = startHeight + dy;
        if (corner.includes('w')) newWidth = startWidth - dx;
        if (corner.includes('n')) newHeight = startHeight - dy;

        // ç­‰æ¯”ä¾‹ç¸®æ”¾
        if (Math.abs(dx) > Math.abs(dy)) {
          newHeight = newWidth / aspect;
        } else {
          newWidth = newHeight * aspect;
        }

        if (newWidth > 20) img.style.width = newWidth + 'px';
        if (newHeight > 20) img.style.height = newHeight + 'px';
      }

      function onMouseUp() {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    });
  });
}

const bulletListBtn = document.getElementById('bullet-list-btn');
bulletListBtn.onclick = () => {
  document.execCommand('insertUnorderedList');
  editor.focus();
};

  // ç‹€æ…‹è®Šæ•¸
  let categories = [];
  let notes = [];
  let selectedCategory = null;
  let currentNoteId = null;

    // å­—é«”å¤§å°é¡¯ç¤º
  const fontSizeDisplay = document.createElement('span');


  // å·¥å…·å‡½å¼
  function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9);
  }

  function saveToLocalStorage() {
    localStorage.setItem('notes', JSON.stringify(notes));
    localStorage.setItem('categories', JSON.stringify(categories));
    localStorage.setItem('selectedCategory', selectedCategory);
  }

  function loadFromLocalStorage() {
    const savedNotes = localStorage.getItem('notes');
    const savedCategories = localStorage.getItem('categories');
    const savedSelectedCategory = localStorage.getItem('selectedCategory');

    if (savedNotes) notes = JSON.parse(savedNotes);
    if (savedCategories) categories = JSON.parse(savedCategories);
    if (savedSelectedCategory) selectedCategory = savedSelectedCategory;
  }

  function loadFontSettings() {
    const savedFont = localStorage.getItem('noteFontFamily');
    const savedFontSize = localStorage.getItem('noteFontSize');
    if (savedFont) {
      fontSelect.value = savedFont;
      editor.style.fontFamily = savedFont;
    }
    if (savedFontSize) {
      fontSizeSelect.value = savedFontSize;
      editor.style.fontSize = savedFontSize;
      fontSizeDisplay.textContent = savedFontSize;
    }
  }

  function openEditor(note = null) {
    noteTitle.style.display = 'block';
    toolbar.style.display = 'flex';
    editor.style.display = 'block';
    searchAddArea.style.display = 'none';
    noteList.style.display = 'none';

    if (note) {
      currentNoteId = note.id;
      noteTitle.value = note.title;
      editor.innerHTML = note.content;
      selectedCategory = note.category || categories[0];
    } else {
      currentNoteId = null;
      noteTitle.value = '';
      editor.innerHTML = '';
      selectedCategory = categories[0] || null;
    }

    editor.focus();
    updateFontSizeDisplay();
  }

  function closeEditor() {
    noteTitle.style.display = 'none';
    toolbar.style.display = 'none';
    editor.style.display = 'none';
    searchAddArea.style.display = 'flex';
    noteList.style.display = 'flex';
    noteTitle.value = '';
    editor.innerHTML = '';
    currentNoteId = null;
  }

  function saveNote() {
    const title = noteTitle.value.trim();
    const content = editor.innerHTML.trim();
    if (!title || !content) return;

    const timestamp = Date.now();
    if (currentNoteId) {
      const note = notes.find(n => n.id === currentNoteId);
      if (note) {
        note.title = title;
        note.content = content;
        note.createdAt = timestamp;
        note.category = selectedCategory;
      }
    } else {
      const newNote = {
        id: generateId(),
        title,
        content,
        createdAt: timestamp,
        category: selectedCategory
      };
      notes.unshift(newNote);
    }

    saveToLocalStorage();
    closeEditor();
    renderNoteList(searchInput.value);
  }

  function deleteNote() {
    if (!currentNoteId) return closeEditor();
    notes = notes.filter(n => n.id !== currentNoteId);
    saveToLocalStorage();
    closeEditor();
    renderNoteList(searchInput.value);
  }

  function renderNoteList(filter = '') {
    noteList.innerHTML = '';
    if (!selectedCategory) {
      noteList.innerHTML = '<p>å°šç„¡åˆ†é¡ï¼Œè«‹æ–°å¢åˆ†é¡</p>';
      return;
    }

    const filteredNotes = notes.filter(note =>
      note.category === selectedCategory &&
      note.title.toLowerCase().includes(filter.toLowerCase())
    );

    if (filteredNotes.length === 0) {
      noteList.innerHTML = '<p>æ‰¾ä¸åˆ°ç­†è¨˜</p>';
      return;
    }

    filteredNotes.forEach(note => {
      const div = document.createElement('div');
      div.className = 'note-item';
      div.dataset.id = note.id;

      div.innerHTML = `
        <div class="note-title">${note.title}</div>
        <div class="note-time">${new Date(note.createdAt).toLocaleString()}</div>
        <div class="note-category">åˆ†é¡ï¼š${note.category}</div>
      `;

      div.onclick = () => openEditor(note);
      noteList.appendChild(div);
    });
  }

  function renderSidebar() {
    sidebarList.innerHTML = '';

    categories.forEach((cat, index) => {
      const li = document.createElement('li');
      li.textContent = cat;
      li.className = (cat === selectedCategory) ? 'active' : '';
      li.draggable = true;
      li.dataset.index = index;

      li.onclick = () => {
        selectedCategory = cat;
        saveToLocalStorage();
        renderSidebar();
        renderNoteList(searchInput.value);
      };

      const delBtn = document.createElement('button');
      delBtn.textContent = 'âŒ';
      delBtn.className = 'delete-cat-btn';
      delBtn.title = 'åˆªé™¤åˆ†é¡';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if (confirm(`ç¢ºå®šåˆªé™¤åˆ†é¡ã€Œ${cat}ã€å—ï¼Ÿæ­¤åˆ†é¡ä¸‹çš„æ‰€æœ‰ç­†è¨˜ä¹Ÿæœƒè¢«åˆªé™¤ã€‚`)) {
          notes = notes.filter(note => note.category !== cat);
          categories = categories.filter(c => c !== cat);
          if (selectedCategory === cat) {
            selectedCategory = categories.length ? categories[0] : null;
          }
          saveToLocalStorage();
          renderSidebar();
          renderNoteList(searchInput.value);
        }
      };
      li.appendChild(delBtn);

      // æ‹–æ‹‰äº‹ä»¶
      li.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', index);
        li.classList.add('dragging');
      });
      li.addEventListener('dragover', e => {
        e.preventDefault();
        li.classList.add('drag-over');
      });
      li.addEventListener('dragleave', () => li.classList.remove('drag-over'));
      li.addEventListener('drop', e => {
        e.preventDefault();
        const from = parseInt(e.dataTransfer.getData('text/plain'));
        const to = parseInt(li.dataset.index);
        if (from !== to) {
          const moved = categories.splice(from, 1)[0];
          categories.splice(to, 0, moved);
          saveToLocalStorage();
          renderSidebar();
        }
      });
      li.addEventListener('dragend', () => {
        li.classList.remove('dragging');
        sidebarList.querySelectorAll('li').forEach(el => el.classList.remove('drag-over'));
      });

      sidebarList.appendChild(li);
    });
  }

  function renderColorPalette() {
    const themeColors = [
      ['#FFEBEB', '#FFB3B3', '#FF7F7F', '#FF4C4C', '#FF1A1A', '#E60000', '#B30000', '#800000'],
      ['#FFEBD6', '#FFCDA3', '#FFB16F', '#FF953C', '#FF7910', '#E66B00', '#B35300', '#804000'],
      ['#FFF8D6', '#FFEF9F', '#FFE76D', '#FFDF3B', '#FFD70A', '#E6C800', '#B39900', '#806600'],
      ['#D6FFE4', '#A3FFC5', '#6FFF9E', '#3BFF76', '#0AFF4E', '#00E640', '#00B32F', '#00661F'],
      ['#D6E7FF', '#A3C9FF', '#6FB0FF', '#3B96FF', '#0A7DFF', '#0066E6', '#004BB3', '#002F80'],
      ['#E6D6FF', '#C3A3FF', '#A06FFF', '#7C3BFF', '#5910FF', '#4B00E6', '#3900B3', '#260080'],
      ['#D6D8DB', '#A8ACB2', '#7B7F89', '#4D525E', '#2F3442', '#1A1F2A', '#0D0F18', '#000000']
    ];

    colorPalette.innerHTML = '';
    themeColors.forEach(row => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'color-row';
      row.forEach(color => {
        const btn = document.createElement('button');
        btn.className = 'color-btn';
        btn.style.backgroundColor = color;
        btn.onclick = () => {
          document.execCommand('foreColor', false, color);
          colorPalette.classList.remove('show');
        };
        rowDiv.appendChild(btn);
      });
      colorPalette.appendChild(rowDiv);
    });
  }

  function applyFontSizeToSelection(size) {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;

    const range = sel.getRangeAt(0);
    if (range.collapsed) {
      editor.style.fontSize = size;
    } else {
      const span = document.createElement('span');
      span.style.fontSize = size;
      span.appendChild(range.extractContents());
      range.insertNode(span);
      sel.removeAllRanges();
      const newRange = document.createRange();
      newRange.selectNodeContents(span);
      sel.addRange(newRange);
    }

    fontSizeDisplay.textContent = size;
    localStorage.setItem('noteFontSize', size);
  }

  function updateFontSizeDisplay() {
    const sel = window.getSelection();
    let node = sel.rangeCount ? sel.anchorNode : null;
    if (node && node.nodeType === Node.TEXT_NODE) node = node.parentNode;
    const size = window.getComputedStyle(node || editor).fontSize;
    fontSizeDisplay.textContent = size;

    Array.from(fontSizeSelect.options).forEach(opt => {
      if (opt.value === size) fontSizeSelect.value = size;
    });
  }

  // ç¶å®šäº‹ä»¶
  boldBtn.onclick = () => document.execCommand('bold');
  italicBtn.onclick = () => document.execCommand('italic');
  underlineBtn.onclick = () => document.execCommand('underline');
  colorPickerBtn.onclick = e => {
    e.stopPropagation();
    colorPalette.classList.toggle('show');
  };
  document.body.onclick = () => colorPalette.classList.remove('show');
  colorPalette.onclick = e => e.stopPropagation();

  fontSelect.onchange = () => {
    editor.style.fontFamily = fontSelect.value;
    localStorage.setItem('noteFontFamily', fontSelect.value);
  };

  fontSizeSelect.onchange = () => {
    applyFontSizeToSelection(fontSizeSelect.value);
    editor.focus();
  };

  newNoteBtn.onclick = () => {
    if (!selectedCategory) return alert('è«‹å…ˆæ–°å¢åˆ†é¡');
    openEditor();
  };

  saveBtn.onclick = saveNote;
  deleteBtn.onclick = deleteNote;
  searchInput.oninput = () => renderNoteList(searchInput.value);
  addCategoryBtn.onclick = () => {
    const name = newCategoryInput.value.trim();
    if (!name) return alert('åˆ†é¡åç¨±ä¸å¯ç©ºç™½');
    if (categories.includes(name)) return alert('åˆ†é¡å·²å­˜åœ¨');
    categories.push(name);
    selectedCategory = name;
    newCategoryInput.value = '';
    saveToLocalStorage();
    renderSidebar();
    renderNoteList();
  };

  
  // åˆå§‹åŒ–
  window.addEventListener('DOMContentLoaded', () => {
    loadFromLocalStorage();
    loadFontSettings();
    renderSidebar();
    renderNoteList();
    renderColorPalette();
    updateFontSizeDisplay();
  });

   // å‡è¨­ä½ æœ‰ä¸€ç­†è³‡æ–™åœ¨ localStorage
  localStorage.setItem('myData', JSON.stringify({ message: 'Hello world' }));

  // ä¸Šå‚³ localStorage è³‡æ–™
  document.getElementById('uploadBtn').onclick = () => {
    const data = localStorage.getItem('myData');
    fetch('http://localhost:3000/upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data })
    })
    .then(res => res.json())
    .then(res => output.textContent = 'âœ… ä¸Šå‚³æˆåŠŸ')
    .catch(err => output.textContent = 'âŒ éŒ¯èª¤: ' + err);
  };

  // å¾ä¼ºæœå™¨ä¸‹è¼‰è³‡æ–™
  document.getElementById('downloadBtn').onclick = () => {
    fetch('http://localhost:3000/data')
    .then(res => res.json())
    .then(res => {
      output.textContent = 'ğŸ“¥ ä¸‹è¼‰åˆ°: ' + res.data;
      localStorage.setItem('myData', res.data); // å¯é¸ï¼šåŒæ­¥å› localStorage
    })
    .catch(err => output.textContent = 'âŒ éŒ¯èª¤: ' + err);
  };
  
  editor.addEventListener('mouseup', updateFontSizeDisplay);
  editor.addEventListener('keyup', updateFontSizeDisplay);
</script>
</body>
</html>
